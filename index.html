<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>SPI Marine Board</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root {
  --bg:#020617;
  --text:#e5e7eb;
  --border:#1f2937;
  --mono:"SF Mono",Menlo,Consolas,monospace;
  --alert-red:#7f1d1d;
  --alert-yellow:#facc15;
}

body {
  margin:0;
  width:100vw;
  height:100vh;
  overflow:hidden;
  background:radial-gradient(circle at top,#1e293b 0,#020617 55%);
  color:var(--text);
  font-family:var(--mono);
  display:flex;
  justify-content:center;
  align-items:center;
}

.board {
  width:100%;
  height:100%;
  padding:4vh 4vw;
  box-sizing:border-box;
  display:flex;
  flex-direction:column;
  gap:5vh;
}

.title {
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:clamp(2rem,4vw,4rem);
}

.grid {
  flex:1;
  width:100%;
  display:grid;
  grid-template-columns:1fr 1fr 1fr 1fr;
  row-gap:4vh;
  column-gap:4vw;
  font-size:clamp(1.4rem,2.8vw,3.2rem);
}

.cell { white-space:nowrap; }

.alert-red {
  background:var(--alert-red);
  color:black !important;
  padding:0.25em 0.4em;
  border-radius:6px;
  width:100%;
  display:inline-block;
}

.alert-yellow {
  background:var(--alert-yellow);
  color:black !important;
  padding:0.25em 0.4em;
  border-radius:6px;
  width:100%;
  display:inline-block;
}
</style>
</head>

<body>
<div class="board">
  <div class="title">
    <div>WEATHER</div>
    <div id="updatedAt">LOADING…</div>
  </div>

  <div class="grid">
    <div></div><div>GULF</div><div>BAY</div><div>TIDES: <span id="tideDate"></span></div>

    <div><span id="waterLabel">WATER</span></div>
    <div><span id="gulfWater">--</span></div>
    <div><span id="bayWater">--</span></div>
    <div>LOW: <span id="tideLow">--</span></div>

    <div><span id="airLabel">AIR</span></div>
    <div><span id="gulfAir">--</span></div>
    <div><span id="bayAir">--</span></div>
    <div>HIGH: <span id="tideHigh">--</span></div>

    <div><span id="windLabel">WIND</span></div>
    <div><span id="gulfWind">--</span></div>
    <div><span id="bayWind">--</span></div>
    <div>SUNRISE: <span id="sunrise">--</span></div>

    <div><span id="seasLabel">SEAS</span></div>
    <div><span id="gulfSeas">--</span></div>
    <div><span id="baySeas">N/A</span></div>
    <div>SUNSET: <span id="sunset">--</span></div>
  </div>
</div>

<script>
/* ======================================================== */
/* GLOBAL CONFIG + OFFLINE STATE */
/* ======================================================== */

let offlineMode = false;

const WORKER_URL="https://noisy-sun-8ce3.jhonbluebrown.workers.dev/weather";
const NOAA_TIDE_STATION="8779750";
const LAT=26.07139, LON=-97.12872;

function pad(n){return String(n).padStart(2,"0");}
function toMil(d){return pad(d.getHours())+":"+pad(d.getMinutes());}
function toMilSec(d){return pad(d.getHours())+":"+pad(d.getMinutes())+":"+pad(d.getSeconds());}

/* ======================================================== */
/* ALERT LOGIC */
/* ======================================================== */

function clearAlerts(){
  document.querySelectorAll('.alert-red,.alert-yellow')
    .forEach(el=>el.classList.remove("alert-red","alert-yellow"));
}

function mark(id,cls){
  document.getElementById(id).classList.add(cls);
}

function applyAlertLogic(w){
  clearAlerts();

  const gw=w.gulf.waterF, bw=w.bay.waterF;
  const ga=w.gulf.airF, ba=w.bay.airF;
  const seas=w.waves.waveFt;

  const waterLow = (gw<60 || bw<60);
  const airLow = (ga<60 || ba<60);

  if(waterLow){
    mark("waterLabel","alert-red");
    mark("gulfWater","alert-red");
    mark("bayWater","alert-red");
  }

  if(airLow && !waterLow){
    mark("airLabel","alert-yellow");
    mark("gulfAir","alert-yellow");
    mark("bayAir","alert-yellow");
  }

  if(airLow && waterLow){
    mark("airLabel","alert-red");
    mark("gulfAir","alert-red");
    mark("bayAir","alert-red");
  }

  if(w.gulf.gustKts>=25 || w.bay.gustKts>=25 ||
     w.gulf.windKts>=25 || w.bay.windKts>=25){
    mark("windLabel","alert-red");
    mark("gulfWind","alert-red");
    mark("bayWind","alert-red");
  }

  if(seas>=8){
    mark("seasLabel","alert-red");
    mark("gulfSeas","alert-red");
  }
  else if(seas>=6){
    mark("seasLabel","alert-yellow");
    mark("gulfSeas","alert-yellow");
  }
}

/* ======================================================== */
/* OFFLINE FALLBACK RENDER */
/* ======================================================== */

function applyCachedWeather(w){
  gulfWater.textContent = w.gulf.waterF+"°F";
  bayWater.textContent  = w.bay.waterF+"°F";
  gulfAir.textContent   = w.gulf.airF+"°F";
  bayAir.textContent    = w.bay.airF+"°F";

  gulfWind.textContent  = `${w.gulf.windKts}-${w.gulf.gustKts} kts ${w.gulf.windDirCardinal}`;
  bayWind.textContent   = `${w.bay.windKts}-${w.bay.gustKts} kts ${w.bay.windDirCardinal}`;

  gulfSeas.textContent  = w.waves.waveFt!=null ? w.waves.waveFt+" ft" : "--";

  applyAlertLogic(w);

  updatedAt.textContent="OFFLINE — LAST SAVED DATA";
  updatedAt.style.color="#facc15";
}

/* ======================================================== */
/* MAIN UPDATE FUNCTION */
/* ======================================================== */

function updateBoard(){
  /* ---------------------- WEATHER ----------------------- */
  fetch(WORKER_URL)
  .then(r=>r.json())
  .then(w=>{
    offlineMode = false;

    localStorage.setItem("lastWeather", JSON.stringify(w));

    gulfWater.textContent=w.gulf.waterF+"°F";
    bayWater.textContent=w.bay.waterF+"°F";
    gulfAir.textContent=w.gulf.airF+"°F";
    bayAir.textContent=w.bay.airF+"°F";

    gulfWind.textContent=`${w.gulf.windKts}-${w.gulf.gustKts} kts ${w.gulf.windDirCardinal}`;
    bayWind.textContent=`${w.bay.windKts}-${w.bay.gustKts} kts ${w.bay.windDirCardinal}`;

    gulfSeas.textContent = w.waves.waveFt!=null ? w.waves.waveFt+" ft" : "--";

    applyAlertLogic(w);
  })
  .catch(err=>{
    console.warn("WEATHER FETCH FAILED — OFFLINE MODE", err);
    offlineMode = true;

    const cached = localStorage.getItem("lastWeather");
    if(cached){
      applyCachedWeather(JSON.parse(cached));
    } else {
      updatedAt.textContent="OFFLINE — NO SAVED DATA";
      updatedAt.style.color="#f00";
    }
  });

  /* ---------------------- TIDES ----------------------- */
  fetch(`https://api.tidesandcurrents.noaa.gov/api/prod/datagetter?product=predictions&station=${NOAA_TIDE_STATION}&date=today&interval=hilo&units=english&time_zone=lst_ldt&datum=MLLW&format=json`)
    .then(r=>r.json())
    .then(t=>{
      const low=t.predictions.find(x=>x.type==="L");
      const high=t.predictions.find(x=>x.type==="H");

      tideLow.textContent = low ?
        `${toMil(new Date(low.t))} / ${(+low.v).toFixed(1)} ft` : "--";

      tideHigh.textContent = high ?
        `${toMil(new Date(high.t))} / ${(+high.v).toFixed(1)} ft` : "--";
    });

  /* ---------------------- SUN ------------------------- */
  fetch(`https://api.sunrise-sunset.org/json?lat=${LAT}&lng=${LON}&formatted=0`)
    .then(r=>r.json())
    .then(s=>{
      sunrise.textContent = toMil(new Date(s.results.sunrise));
      sunset.textContent  = toMil(new Date(s.results.sunset));
    });

  /* ---------------------- TIMESTAMP -------------------- */
  const now=new Date();
  updatedAt.style.color="#e5e7eb";
  updatedAt.textContent="UPDATED "+toMilSec(now)+" LCL";

  const dd=pad(now.getDate());
  const mm=["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"][now.getMonth()];
  const yy=String(now.getFullYear()).slice(2);

  tideDate.textContent=`${dd} ${mm} ${yy}`;
}

/* ======================================================== */
/* LOOP + SAFE RELOAD */
/* ======================================================== */

updateBoard();
setInterval(updateBoard,60000);

setInterval(()=>{
  if(!offlineMode){
    location.reload();
  } else {
    console.warn("Offline — skipped auto reload");
  }
}, 5 * 60 * 1000);

/* Live clock text */
setInterval(()=>{
  if(!offlineMode){
    updatedAt.textContent="UPDATED "+toMilSec(new Date())+" LCL";
  }
},1000);

</script>
</body>
</html>
